<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Ticket System</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- QRCode.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
    <!-- Google Fonts (Inter and Padauk) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Padauk:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Body အတွက် အခြေခံ စတိုင်များ */
        body {
            font-family: 'Padauk', 'Inter', sans-serif;
            background-color: #111827; /* အမှောင် နောက်ခံအရောင် */
            color: #F3F4F6; /* အလင်းရောင် စာသား */
        }
        /* Page များကို ပြသရန်/ဝှက်ရန် */
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        /* ခုံများအတွက် အခြေခံ စတိုင်များ */
        .seat {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            margin: 3px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 500;
            transition: transform 0.2s, background-color 0.2s;
            flex-shrink: 0; /* နေရာမလုံလောက်လျှင် ခုံများ မကျုံ့စေရန် */
        }
        /* Sofa/Suite ခုံများသည် ပိုကျယ်သည် */
        .seat.price-800 {
            width: 32px; 
        }
        /* ရောင်းပြီးသား သို့မဟုတ် နေရာလွတ်မဟုတ်သော ခုံများပေါ်တွင် မောက်စ်တင်လိုက်လျှင် အရွယ်အစား အနည်းငယ် ကြီးလာစေရန် */
        .seat:not(.sold):not(.space):hover {
            transform: scale(1.1);
        }
        /* ဈေးနှုန်းအလိုက် ခုံအရောင်များ */
        .seat.price-300 { background-color: #34D399; color: #064E3B; } /* အစိမ်းရောင် */
        .seat.price-500 { background-color: #60A5FA; color: #1E3A8A; } /* အပြာရောင် */
        .seat.price-800 { background-color: #F472B6; color: #831843; } /* ပန်းရောင် */

        /* ရွေးချယ်ထားသော ခုံများ */
        .seat.selected { background-color: #FBBF24; color: #78350F; font-weight: bold; } /* ပယင်းရောင် */
        /* ရောင်းပြီးသား ခုံများ */
        .seat.sold { background-color: #4B5563; cursor: not-allowed; } /* မီးခိုးရောင် */
        /* နေရာလွတ်များ */
        .seat.space { background-color: transparent; cursor: default; }

        /* ခုံတန်းများအတွက် စတိုင်များ */
        .seat-row {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 5px;
            flex-wrap: nowrap; /* ခုံတန်းများ တစ်တန်းတည်းရှိနေစေရန် */
        }
        /* တန်းအမည် (ဥပမာ: A, B, C) အတွက် စတိုင်များ */
        .row-label {
            width: 40px;
            text-align: right;
            margin-right: 10px;
            font-weight: bold;
            color: #9CA3AF;
        }
        /* ဖန်သားပြင် (Screen) အတွက် စတိုင်များ */
        .screen {
            width: 90%;
            margin: 24px auto;
            padding: 8px;
            background-color: #374151;
            text-align: center;
            border-radius: 8px;
            border-bottom: 5px solid #F9FAFB;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
        }
        /* ခလုတ်များအတွက် အခြေခံ စတိုင်များ */
        .btn {
            display: inline-block;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
        }
        /* အဓိက ခလုတ် (Primary Button) */
        .btn-primary {
            background-color: #3B82F6;
            color: white;
        }
        .btn-primary:hover {
            background-color: #2563EB;
            transform: translateY(-2px);
        }
        /* ဒုတိယ ခလုတ် (Secondary Button) */
         .btn-secondary {
            background-color: #6B7280;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #4B5563;
        }
        /* နောက်ပြန်ခလုတ် (Back Button) */
        .btn-back {
            padding: 8px 16px;
        }
        
        /* Responsive styles for mobile (640px အောက် မျက်နှာပြင်များ) */
        @media (max-width: 640px) {
            .seat {
                width: 24px;
                height: 24px;
                margin: 2px;
                font-size: 10px;
            }
            .seat.price-800 {
                width: 28px;
            }
            .row-label {
                width: 30px;
                margin-right: 5px;
                font-size: 0.8rem;
            }
            h1 {
                font-size: 1.5rem !important; /* Tailwind ကို override လုပ်ရန် !important အသုံးပြုသည် */
            }
        }

        /* Responsive styles for smaller mobile (420px အောက် မျက်နှာပြင်များ) */
        @media (max-width: 420px) {
             .seat {
                width: 20px;
                height: 20px;
                margin: 2px;
                font-size: 9px;
            }
            .seat.price-800 {
                width: 24px;
            }
            .row-label {
                width: 25px;
                margin-right: 4px;
            }
        }
        
        /* Responsive styles for very small mobile (375px အောက် မျက်နှာပြင်များ) */
        @media (max-width: 375px) {
             .seat {
                width: 18px;
                height: 18px;
                margin: 1px;
                font-size: 8px;
                border-radius: 4px;
            }
            .seat.price-800 {
                width: 22px;
            }
            .row-label {
                width: 22px;
                font-size: 0.7rem;
            }
        }

        /* Loading Overlay စတိုင် */
        #loadingOverlay {
            background-color: rgba(17, 24, 39, 0.75); /* bg-gray-900 with opacity */
            display: flex;
            align-items: center;
            justify-content: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 50;
        }
        #loadingOverlay.hidden {
            display: none;
        }
        /* Spinner Animation */
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

    </style>
</head>
<body class="antialiased">

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="hidden">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500 mx-auto mb-4"></div>
            <p class="text-white text-lg">Loading...</p>
        </div>
    </div>

    <div id="app-container" class="max-w-5xl mx-auto p-2 sm:p-6">

        <!-- Page 1: Intro -->
        <div id="introPage" class="page active">
            <div class="bg-gray-800 p-4 md:p-6 rounded-lg shadow-lg text-center">
                <h1 class="text-4xl font-bold mb-4">What happened to the wolf?</h1>
            
                <img src="https://raw.githubusercontent.com/Khunnaingpyaehtun/Ticket-System/main/Poster.png" 
                     onerror="this.onerror=null;this.src='https://placehold.co/600x400/1f2937/ffffff?text=Poster%20Not%20Found';"
                     alt="Movie Poster" class="w-full max-w-md mx-auto rounded-lg mb-6 shadow-md">
                <div class="mb-6">
                    <h2 class="text-2xl font-semibold mb-2">ပြသမည့်နေရာများ</h2>
                    <div class="flex justify-center space-x-4 text-lg">
                        <span>Bangkok</span>
                        <span>Chiang Mai</span>
                        <span>Mae Sot</span>
                    </div>
                </div>
                <button id="buyTicketsBtn" class="btn btn-primary text-xl">Buy Tickets</button>
                <p class="text-sm text-gray-500 mt-4">User ID: <span id="currentUserId">Loading...</span></p>
            </div>
        </div>

        <!-- Page 2: Cinema Information -->
        <div id="cinemaSelectionPage" class="page">
             <div class="bg-gray-800 p-4 md:p-6 rounded-lg shadow-lg text-center relative">
                <div class="absolute top-4 left-4">
                    <button id="backToIntroBtn" class="btn btn-secondary btn-back">&lt; နောက်သို့</button>
                </div>
                <h1 class="text-3xl font-bold mb-6 pt-8">ရုပ်ရှင်ရုံ ရွေးချယ်ပါ</h1>
                <div class="space-y-4">
                    <button class="btn btn-secondary w-full text-lg" data-cinema="maesot">SF CINEMA (MAE SOT)</button>
                    <button class="btn btn-secondary w-full text-lg" data-cinema="chiangmai">SFX CINEMA (MAYA CHIANGMAI)</button>
                    <button class="btn btn-secondary w-full text-lg" data-cinema="mbk">SF CINEMA (MBK CENTER)</button>
                </div>
            </div>
        </div>

        <!-- Page 3: Seating Plan -->
        <div id="seatingPlanPage" class="page">
            <div class="bg-gray-800 p-2 sm:p-4 md:p-6 rounded-lg shadow-lg relative">
                <div class="absolute top-4 left-4 z-10">
                    <button id="backToCinemaBtn" class="btn btn-secondary btn-back">&lt; နောက်သို့</button>
                </div>
                <h1 id="cinemaName" class="text-3xl font-bold text-center mb-2 pt-8"></h1>
                <p id="cinemaTime" class="text-center text-gray-400 mb-4"></p>
                
                <div class="screen">SCREEN</div>
                <div id="seatingContainer" class="overflow-x-auto pb-4">
                  <div id="seatingGrid" class="flex flex-col items-center my-6 min-w-max"></div>
                </div>


                <div class="flex flex-wrap justify-center gap-x-4 gap-y-2 my-6">
                    <div class="flex items-center"><div class="seat price-300 !m-0"></div><span class="ml-2">300 Baht</span></div>
                    <div class="flex items-center"><div class="seat price-500 !m-0"></div><span class="ml-2">500 Baht</span></div>
                    <div class="flex items-center"><div class="seat price-800 !m-0"></div><span class="ml-2">800 Baht</span></div>
                    <div class="flex items-center"><div class="seat selected !m-0"></div><span class="ml-2">ရွေးချယ်ထား</span></div>
                    <div class="flex items-center"><div class="seat sold !m-0"></div><span class="ml-2">ရောင်းပြီး</span></div>
                </div>

                <div class="text-center mt-6 bg-gray-900 p-4 rounded-lg">
                    <p class="text-lg md:text-xl">ရွေးချယ်ထားသောခုံများ: <span id="selectedSeatsInfo" class="font-bold text-amber-400">-</span></p>
                    <p class="text-xl md:text-2xl mt-2">စုစုပေါင်းကျသင့်ငွေ: <span id="totalPriceInfo" class="font-bold text-green-400">0 Baht</span></p>
                    <button id="confirmBookingBtn" class="btn btn-primary mt-4 text-lg">Confirm</button>
                    <div id="seatingErrorMessage" class="text-red-500 font-bold mt-4"></div>
                </div>
            </div>
        </div>

        <!-- Page 4: Payment -->
        <div id="paymentPage" class="page">
            <div class="bg-gray-800 p-4 md:p-6 rounded-lg shadow-lg text-center relative">
                <div class="absolute top-4 left-4">
                    <button id="backToSeatingBtn" class="btn btn-secondary btn-back">&lt; နောက်သို့</button>
                </div>
                <h1 class="text-3xl font-bold mb-6 pt-8">အတည်ပြုခြင်းနှင့် ငွေပေးချေခြင်း</h1>
                <div class="text-left bg-gray-700 p-4 rounded-lg space-y-3">
                    <p><strong>ရုပ်ရှင်ရုံ:</strong> <span id="paymentCinemaName"></span></p>
                    <p><strong>ပြသချိန်:</strong> <span id="paymentCinemaTime"></span></p>
                    <p><strong>ခုံနံပါတ်များ:</strong> <span id="paymentSelectedSeats" class="font-bold"></span></p>
                    <p><strong>Booking အချိန်:</strong> <span id="bookingTime"></span></p>
                    <p class="text-2xl mt-4"><strong>စုစုပေါင်း:</strong> <span id="paymentTotalPrice" class="font-bold text-green-400"></span></p>
                </div>
                <div class="mt-6">
                    <p id="countdownMessage" class="text-red-400 font-bold text-lg">ငွေပေးချေမှုကို ၁၅ မိနစ်အတွင်း အပြီးဆောင်ရွက်ပါ။</p>
                    <p id="countdownTimer" class="text-2xl font-bold text-red-500 my-2"></p>
                </div>
                <div class="flex justify-center items-center gap-4 mt-4">
                     <a id="paymentLink" href="#" target="_blank" class="btn btn-primary text-xl">Pay</a>
                </div>
               
                <div class="mt-8 border-t border-gray-700 pt-6">
                    <h2 class="text-xl font-semibold mb-4">သင်၏ Booking QR Code</h2>
                    <canvas id="qrCanvas" class="mx-auto bg-white p-2 rounded-lg shadow-md"></canvas>
                    <a id="downloadQRBtn" class="btn btn-secondary mt-4 inline-block">Download QR Code</a>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase SDKs များကို import လုပ်ခြင်း
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, runTransaction, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Canvas environment မှ ပေးပို့သော Global variables များ
        // ဤနေရာတွင် သင့်ကိုယ်ပိုင် Firebase config ကို တိုက်ရိုက်ထည့်သွင်းနိုင်သည်၊ သို့မဟုတ် Canvas environment မှ ပေးပို့သည်ကို အသုံးပြုနိုင်သည်
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let userId; // လက်ရှိ အသုံးပြုသူ၏ ID

        // DOMContentLoaded Event Listener
        document.addEventListener('DOMContentLoaded', async () => {
            const pages = document.querySelectorAll('.page');
            const buyTicketsBtn = document.getElementById('buyTicketsBtn');
            const cinemaButtons = document.querySelectorAll('#cinemaSelectionPage button');
            const confirmBookingBtn = document.getElementById('confirmBookingBtn');
            const paymentLink = document.getElementById('paymentLink');
            const seatingErrorMessage = document.getElementById('seatingErrorMessage');

            // နောက်ပြန်ခလုတ်များ
            const backToIntroBtn = document.getElementById('backToIntroBtn');
            const backToCinemaBtn = document.getElementById('backToCinemaBtn');
            const backToSeatingBtn = document.getElementById('backToSeatingBtn');

            let selectedCinema = {};
            let selectedSeats = [];
            let totalPrice = 0;
            let countdownInterval;
            const COUNTDOWN_SECONDS = 15 * 60; // ငွေပေးချေမှုအတွက် ၁၅ မိနစ် သတ်မှတ်ထားသည်

            let unsubscribeFromSeats = null; // Firestore listener ကို သိမ်းဆည်းရန်

            // Firebase ကို initialize လုပ်ခြင်း
            if (Object.keys(firebaseConfig).length > 0) {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Firebase Authentication
                try {
                    if (initialAuthToken) {
                        // Canvas environment မှ ပေးပို့သော token ဖြင့် sign in လုပ်သည်
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        // token မရှိလျှင် anonymous အနေဖြင့် sign in လုပ်သည်
                        await signInAnonymously(auth);
                    }
                    userId = auth.currentUser?.uid || crypto.randomUUID(); // အသုံးပြုသူ ID ကို ရယူသည်
                    console.log("Firebase authenticated. User ID:", userId);
                    document.getElementById('currentUserId').textContent = userId; // User ID ကို UI တွင် ပြသသည်
                } catch (error) {
                    console.error("Firebase authentication failed:", error);
                    document.getElementById('currentUserId').textContent = "Authentication Error";
                    // Authentication error ဖြစ်ပါက အသုံးပြုသူအား ပြသနိုင်သည်
                }
            } else {
                console.warn("Firebase config not found. Running in demo mode without persistence.");
                document.getElementById('currentUserId').textContent = "Demo Mode (No Persistence)";
                // Firebase config မရှိလျှင် persistence လိုအပ်သော လုပ်ဆောင်ချက်များကို ပိတ်ထားနိုင်သည်
            }

            // ရုပ်ရှင်ပိုစတာအတွက် ယုံကြည်စိတ်ချရသော ပုံ URL ကို အသုံးပြုသည်
            document.querySelector('#introPage img').src = 'https://raw.githubusercontent.com/Khunnaingpyaehtun/Ticket-System/main/Poster.png';

            // ရုပ်ရှင်ရုံ အချက်အလက်နှင့် ခုံနေရာချထားမှုများ (PDF အပေါ် အခြေခံ၍ ပြင်ဆင်ထားသည်)
            // s=sofa/suite(800), p=premium/prime(500), n=normal/deluxe(300), x=sold, _=space
            const cinemaData = {
                 'maesot': {
                    id: 'maesot', // Cinema ID ထည့်သွင်းထားသည်
                    name: 'SF CINEMA (MAE SOT)',
                    time: '၁၉/၇/၂၀၂၅ ညနေ ၃:၀၀',
                    prices: { n: 300, p: 500, s: 800 },
                    rowLabels: ["M", "L", "K", "J", "H", "G", "F", "E", "D", "C", "B", "A", "AA"],
                    layout: [
                        "nnn_nnnnnnnnnnnnnnnn_nnn",   // M: 22
                        "nnn_nnnnnnnnnnnnnnnn_nnn",   // L: 22
                        "nnn_nnnnnnnnnnnnnnnn_nnn",   // K: 22
                        "nnn_nnnnnnnnnnnnnnnn_nnn",   // J: 22
                        "nnn_nnnnnnnnnnnnnnnn_nnn",   // H: 22
                        "nnn_nnnnnnnnnnnnnnnn_nnn",   // G: 22
                        "nnn_nnnnnnnnnnnnnnnn_nnn",   // F: 22
                        "nnn_nnnnnnnnnnnnnnnn_nnn",   // E: 22
                        "ppp_pppppppppppppppp_ppp",   // D: 22
                        "ppp_pppppppppppppppp_ppp",   // C: 22
                        "ppp_pppppppppppppppp_ppp",   // B: 22
                        "ppp_pppppppppppppppp_ppp",   // A: 22
                        "sss_sssssss_sss",            // AA: 13
                    ]
                },
                'chiangmai': {
                    id: 'chiangmai', // Cinema ID ထည့်သွင်းထားသည်
                    name: 'SFX CINEMA (MAYA CHIANGMAI)',
                    time: '၁၉/၇/၂၀၂၅ ညနေ ၆:၀၀',
                    prices: { n: 300, p: 500, s: 800 },
                    rowLabels: ["N", "M", "L", "K", "J", "H", "G", "F", "E", "D", "C", "B", "A", "AA"],
                    layout: [
                        "nnnnnnnnnnnnnnnnnnnnnnnn",  // N: 24
                        "nnnnnnnnnnnnnnnnnnnnnnnn",  // M: 24
                        "nnnnnnnnnnnnnnnnnnnnnnnn",  // L: 24
                        "nnnnnnnnnnnnnnnnnnnnnnnn",  // K: 24
                        "nnnnnnnnnnnnnnnnnnnnnnnn",  // J: 24
                        "nnnnnnnnnnnnnnnnnnnnnnnn",  // H: 24
                        "nnnnnnnnnnnnnnnnnnnnnnnn",  // G: 24
                        "nnnnnnnnnnnnnnnnnnnnnnnn",  // F: 24
                        "nnnnnnnnnnnnnnnnnnnnnnnn",  // E: 24
                        "nnnnnnnnnnnnnnnnnnnnnnnn",  // D: 24
                        "pppppppppppppppppppppp",    // C: 22
                        "pppppppppppppppppppppp",    // B: 22
                        "pppppppppppppppppppppp",    // A: 22
                        "ss_ss_ss_ss_ss_ss",         // AA: 12
                    ]
                },
                'mbk': {
                    id: 'mbk', // Cinema ID ထည့်သွင်းထားသည်
                    name: 'SF CINEMA (MBK CENTER)',
                    time: '၁၉/၇/၂၀၂၅ ညနေ ၄:၀၀',
                    prices: { n: 300, p: 500, s: 800 },
                    rowLabels: ["P", "N", "M", "L", "K", "J", "H", "G", "F", "E", "D", "C", "B", "A", "AA"],
                    layout: [
                        "nnnnnnnnnn_nnnnnnnnnn", // P: 20
                        "nnnnnnnnnn_nnnnnnnnnn", // N: 20
                        "nnnnnnnnnn_nnnnnnnnnn", // M: 20
                        "nnnnnnnnnn_nnnnnnnnnn", // L: 20
                        "nnnnnnnnnn_nnnnnnnnnn", // K: 20
                        "nnnnnnnnnn_nnnnnnnnnn", // J: 20
                        "nnnnnnnnnn_nnnnnnnnnn", // H: 20
                        "nnnnnnnnnn_nnnnnnnnnn", // G: 20
                        "nnnnnnnnnn_nnnnnnnnnn", // F: 20
                        "ppppppppp_ppppppppp",   // E: 18
                        "ppppppppp_ppppppppp",   // D: 18
                        "ppppppppp_ppppppppp",   // C: 18
                        "ppppppppp_ppppppppp",   // B: 18
                        "ppppppppp_ppppppppp",   // A: 18
                        "ssssss_ssssss",         // AA: 12
                    ]
                }
            };

            // Show loading overlay
            function showLoading() {
                document.getElementById('loadingOverlay').classList.remove('hidden');
            }

            // Hide loading overlay
            function hideLoading() {
                document.getElementById('loadingOverlay').classList.add('hidden');
            }
            
            // စာမျက်နှာများ ပြောင်းလဲရန် လုပ်ဆောင်ချက်
            function navigateTo(pageId) {
                clearInterval(countdownInterval); // စာမျက်နှာပြောင်းတိုင်း countdown ကို ရပ်သည်
                if (unsubscribeFromSeats) { // Seating plan မှ ထွက်ခွာလျှင် Firestore listener ကို ရှင်းလင်းသည်
                    unsubscribeFromSeats();
                    unsubscribeFromSeats = null;
                }
                pages.forEach(page => {
                    page.classList.remove('active');
                    if (page.id === pageId) {
                        page.classList.add('active');
                    }
                });
                window.scrollTo(0, 0); // စာမျက်နှာအပေါ်ဆုံးသို့ ပြန်ရွှေ့သည်
            }

            // ရွေးချယ်ထားသော ခုံများနှင့် စုစုပေါင်း ဈေးနှုန်းကို update လုပ်ရန်
            function updateSelectionSummary() {
                const selectedSeatsInfo = document.getElementById('selectedSeatsInfo');
                const totalPriceInfo = document.getElementById('totalPriceInfo');

                if (selectedSeats.length === 0) {
                    selectedSeatsInfo.textContent = '-';
                    totalPriceInfo.textContent = '0 Baht';
                } else {
                    selectedSeatsInfo.textContent = selectedSeats.map(s => s.id).sort().join(', ');
                    totalPriceInfo.textContent = `${totalPrice} Baht`;
                }
                
                // ခုံမရွေးရသေးလျှင် Confirm ခလုတ်ကို ပိတ်ထားရန်
                confirmBookingBtn.disabled = selectedSeats.length === 0;
                confirmBookingBtn.classList.toggle('opacity-50', confirmBookingBtn.disabled);
                confirmBookingBtn.classList.toggle('cursor-not-allowed', confirmBookingBtn.disabled);
            }

            // Showtime string ကို Firestore document ID အတွက် format ပြောင်းလဲရန်
            function formatShowtimeForId(showtimeString) {
                // ဥပမာ: '၁၉/၇/၂၀၂၅ ညနေ ၃:၀၀' -> '19-7-2025-15-00'
                const parts = showtimeString.split(' ');
                const datePart = parts[0].replace(/\//g, '-'); 
                let timePart = parts[2]; 

                // ညနေ (PM) ကို 24-hour format သို့ ပြောင်းလဲခြင်း (ရိုးရှင်းသော ဥပမာ)
                if (parts[1] === 'ညနေ') {
                    let [hour, minute] = timePart.split(':').map(Number);
                    if (hour < 12) hour += 12; 
                    timePart = `${hour.toString().padStart(2, '0')}-${minute.toString().padStart(2, '0')}`;
                } else {
                    timePart = timePart.replace(/:/g, '-');
                }
                return `${datePart}-${timePart}`;
            }

            // ခုံနေရာချထားမှုကို ဖန်တီးရန် (Firestore မှ data ဖြင့်)
            function renderSeatingGrid(soldSeatsFromFirestore) {
                const seatingGrid = document.getElementById('seatingGrid');
                seatingGrid.innerHTML = ''; // ရှိပြီးသား ခုံများကို ရှင်းလင်းသည်

                // စုစုပေါင်း ဈေးနှုန်းနှင့် ရွေးချယ်ထားသော ခုံများကို ပြန်လည်တွက်ချက်ရန် ယာယီသိမ်းဆည်းထားသည်
                let tempSelectedSeats = [];
                let tempTotalPrice = 0;

                selectedCinema.layout.forEach((rowLayout, rowIndex) => {
                    const rowLabelText = selectedCinema.rowLabels[rowIndex];
                    const rowDiv = document.createElement('div');
                    rowDiv.className = 'seat-row';
                    
                    const rowLabelDiv = document.createElement('div');
                    rowLabelDiv.className = 'row-label';
                    rowLabelDiv.textContent = rowLabelText;
                    rowDiv.appendChild(rowLabelDiv);

                    let seatNumber = 1;
                    for (let i = 0; i < rowLayout.length; i++) {
                        const seatType = rowLayout[i];
                        const seat = document.createElement('div');
                        
                        if (seatType === '_') {
                            seat.className = 'seat space'; // နေရာလွတ်
                        } else {
                            const seatId = `${rowLabelText}${seatNumber}`;
                            seat.dataset.seatId = seatId;
                            seat.textContent = seatNumber;

                            if (soldSeatsFromFirestore[seatId]) { // Firestore data ကို စစ်ဆေးပြီး ရောင်းပြီးသား ခုံများကို ပြသည်
                                seat.className = 'seat sold'; // ရောင်းပြီးသား ခုံ
                            } else {
                                const price = selectedCinema.prices[seatType];
                                let priceClass = '';
                                if(price === 300) priceClass = 'price-300';
                                else if(price === 500) priceClass = 'price-500';
                                else if(price === 800) priceClass = 'price-800';

                                seat.className = `seat ${priceClass}`; // ဈေးနှုန်းအလိုက် အရောင်
                                seat.dataset.price = price;
                                
                                // အသုံးပြုသူက ယခင်က ရွေးချယ်ထားသော ခုံများကို ပြန်လည်ရွေးချယ်ထားသည့်အတိုင်း ပြသသည်
                                const isSelectedByUser = selectedSeats.some(s => s.id === seatId);
                                if (isSelectedByUser) {
                                    seat.classList.add('selected');
                                    tempSelectedSeats.push({id: seatId, price: seat.dataset.price});
                                    tempTotalPrice += parseInt(seat.dataset.price);
                                }

                                // ခုံကို နှိပ်လျှင် ရွေးချယ်/မရွေးချယ် လုပ်ဆောင်ချက်
                                seat.addEventListener('click', () => {
                                    if (seat.classList.contains('selected')) {
                                        seat.classList.remove('selected');
                                        totalPrice -= parseInt(seat.dataset.price);
                                        selectedSeats = selectedSeats.filter(s => s.id !== seatId);
                                    } else {
                                        seat.classList.add('selected');
                                        totalPrice += parseInt(seat.dataset.price);
                                        selectedSeats.push({id: seatId, price: seat.dataset.price});
                                    }
                                    updateSelectionSummary(); // ရွေးချယ်မှု အကျဉ်းချုပ်ကို update လုပ်သည်
                                });
                            }
                            seatNumber++;
                        }
                        rowDiv.appendChild(seat);
                    }
                    rowDiv.setAttribute('aria-label', `Row ${rowLabelText}`); // Accessibility အတွက် aria-label ထည့်သွင်းသည်
                    seatingGrid.appendChild(rowDiv);
                });
                // Update global selectedSeats and totalPrice based on the re-rendered state
                selectedSeats = tempSelectedSeats;
                totalPrice = tempTotalPrice;
                updateSelectionSummary(); // ရွေးချယ်မှု အကျဉ်းချုပ်ကို update လုပ်သည်
            }

            // ခုံနေရာချထားမှုကို ဖန်တီးရန်နှင့် Firestore မှ data ဆွဲယူရန်
            async function generateSeatingPlan(cinemaId) {
                selectedCinema = cinemaData[cinemaId];
                document.getElementById('cinemaName').textContent = selectedCinema.name;
                document.getElementById('cinemaTime').textContent = selectedCinema.time;
                seatingErrorMessage.textContent = ''; // Error message ရှင်းလင်းသည်

                // ယခင် listener ကို ရှင်းလင်းသည်
                if (unsubscribeFromSeats) {
                    unsubscribeFromSeats();
                    unsubscribeFromSeats = null;
                }

                if (!db) {
                    console.error("Firestore is not initialized. Cannot fetch seat data.");
                    renderSeatingGrid({}); // Firestore မရှိလျှင် ခုံများကို ရောင်းပြီးသားမရှိဘဲ ပြသသည်
                    navigateTo('seatingPlanPage');
                    return;
                }

                showLoading(); // Loading ပြသည်

                const cinemaSeatsDocRef = doc(db, `artifacts/${appId}/public/data/cinemaSeats`, `${selectedCinema.id}-${formatShowtimeForId(selectedCinema.time)}`);

                // Real-time listener ကို စတင်သည်
                unsubscribeFromSeats = onSnapshot(cinemaSeatsDocRef, (docSnap) => {
                    const soldSeatsFromFirestore = docSnap.exists() ? docSnap.data().soldSeats || {} : {};
                    renderSeatingGrid(soldSeatsFromFirestore); // အပ်ဒိတ်လုပ်ထားသော data ဖြင့် ခုံများကို ပြန်လည်ပြသသည်
                    hideLoading(); // Loading ကို ဖျောက်သည်
                }, (error) => {
                    console.error("Error listening to seat updates:", error);
                    seatingErrorMessage.textContent = `Error loading seats: ${error.message}. Please try again.`;
                    hideLoading(); // Loading ကို ဖျောက်သည်
                });

                navigateTo('seatingPlanPage');
            }

            // Countdown Timer စတင်ရန် လုပ်ဆောင်ချက်
            function startCountdown() {
                let timeLeft = COUNTDOWN_SECONDS;
                const timerEl = document.getElementById('countdownTimer');
                const messageEl = document.getElementById('countdownMessage');

                const updateTimer = () => {
                    if (timeLeft <= 0) {
                        clearInterval(countdownInterval);
                        messageEl.textContent = "⏰ အချိန်စေ့သွားပါပြီ။ ကျေးဇူးပြု၍ပြန်စပါ။";
                        timerEl.textContent = "Reloading...";
                        setTimeout(() => location.reload(), 2000); // အချိန်ကုန်လျှင် စာမျက်နှာကို reload လုပ်သည်
                        return;
                    }
                    timeLeft--;
                    const minutes = Math.floor(timeLeft / 60);
                    const seconds = timeLeft % 60;
                    timerEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                };
                
                updateTimer();
                countdownInterval = setInterval(updateTimer, 1000); // ၁ စက္ကန့်တိုင်း update လုပ်သည်
            }
            
            // ငွေပေးချေမှု စာမျက်နှာကို ပြသရန်
            function showPaymentPage() {
                // ဤ function သည် booking transaction အောင်မြင်ပြီးမှသာ ခေါ်ဆိုပါမည်။
                const cinemaNameEl = document.getElementById('paymentCinemaName');
                const cinemaTimeEl = document.getElementById('paymentCinemaTime');
                const selectedSeatsEl = document.getElementById('paymentSelectedSeats');
                const totalPriceEl = document.getElementById('paymentTotalPrice');
                const bookingTimeEl = document.getElementById('bookingTime');
                
                const sortedSeats = selectedSeats.map(s => s.id).sort().join(', '); // ရွေးချယ်ထားသော ခုံများကို စီ၍ ပြသည်
                const now = new Date();
                const bookingTimeText = `${now.toLocaleDateString()} ${now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;

                cinemaNameEl.textContent = selectedCinema.name;
                cinemaTimeEl.textContent = selectedCinema.time;
                selectedSeatsEl.textContent = sortedSeats;
                totalPriceEl.textContent = `${totalPrice} Baht`;
                bookingTimeEl.textContent = bookingTimeText;

                paymentLink.href = 'https://m.me/24framesmozart'; // ငွေပေးချေမှု လင့်ခ်

                navigateTo('paymentPage');
                startCountdown(); // Countdown timer ကို စတင်သည်
                generateAndSetupQRCode(sortedSeats, bookingTimeText); // QR Code ကို ဖန်တီးသည်
            }

            // QR Code ကို ဖန်တီးပြီး download လုပ်ရန်
            function generateAndSetupQRCode(sortedSeats, bookingTimeText) {
                const canvas = document.getElementById('qrCanvas');
                const downloadBtn = document.getElementById('downloadQRBtn');

                const qrText = `Movie: What happened to the wolf?\nCinema: ${selectedCinema.name}\nShowtime: ${selectedCinema.time}\nSeats: ${sortedSeats}\nTotal: ${totalPrice} Baht\nBooking Time: ${bookingTimeText}`;

                QRCode.toCanvas(canvas, qrText, { width: 220, margin: 2 }, function (error) {
                    if (error) {
                        console.error(error);
                        canvas.style.display = 'none'; // error ရှိလျှင် canvas ကို ဝှက်သည်
                        downloadBtn.style.display = 'none'; // error ရှိလျှလျှင် download ခလုတ်ကို ဝှက်သည်
                        return;
                    }
                    console.log('QR code generated successfully!');
                    downloadBtn.href = canvas.toDataURL('image/png'); // QR code ပုံကို download လုပ်ရန်
                    downloadBtn.download = `what-happened-to-the-wolf-booking.png`;
                });
            }

            // Booking လုပ်ဆောင်ရန် လုပ်ဆောင်ချက် (Firestore Transaction ပါဝင်သည်)
            async function attemptBooking() {
                if (selectedSeats.length === 0) {
                    seatingErrorMessage.textContent = 'ကျေးဇူးပြု၍ ခုံများ ရွေးချယ်ပါ။';
                    return;
                }
                if (!db) {
                    seatingErrorMessage.textContent = 'Database မရရှိနိုင်ပါ။ ကျေးဇူးပြု၍ စာမျက်နှာကို ပြန်လည်တင်ပါ။';
                    return;
                }

                seatingErrorMessage.textContent = ''; // ယခင် error message ရှင်းလင်းသည်
                showLoading(); // Loading ပြသည်

                const cinemaSeatsDocRef = doc(db, `artifacts/${appId}/public/data/cinemaSeats`, `${selectedCinema.id}-${formatShowtimeForId(selectedCinema.time)}`);

                try {
                    await runTransaction(db, async (transaction) => {
                        const docSnap = await transaction.get(cinemaSeatsDocRef);
                        let currentSoldSeats = docSnap.exists() ? docSnap.data().soldSeats || {} : {};

                        const seatsToUpdate = {};
                        for (const seat of selectedSeats) {
                            if (currentSoldSeats[seat.id]) {
                                // ဤခုံသည် ရောင်းပြီးသားဖြစ်နေလျှင် transaction ကို ပယ်ဖျက်သည်
                                throw new Error(`Seat ${seat.id} is already sold. Please select another seat.`);
                            }
                            seatsToUpdate[seat.id] = true; // ရောင်းပြီးသားအဖြစ် မှတ်သားသည်
                        }

                        // ရောင်းပြီးသား ခုံအသစ်များကို ရှိပြီးသားများနှင့် ပေါင်းစပ်သည်
                        const newSoldSeats = { ...currentSoldSeats, ...seatsToUpdate };
                        transaction.set(cinemaSeatsDocRef, {
                            cinemaName: selectedCinema.name,
                            showtime: selectedCinema.time,
                            soldSeats: newSoldSeats
                        }, { merge: true }); // merge ကို အသုံးပြု၍ soldSeats map ကိုသာ update လုပ်သည်

                        // Transaction အောင်မြင်လျှင် payment page သို့ သွားသည်
                        showPaymentPage();
                    });
                    console.log("Booking transaction successfully committed!");
                } catch (e) {
                    console.error("Booking transaction failed: ", e);
                    seatingErrorMessage.textContent = `Booking failed: ${e.message || 'An unexpected error occurred.'} ကျေးဇူးပြု၍ ပြန်လည်ကြိုးစားပါ။`;
                    // Error ဖြစ်လျှင် ခုံအခြေအနေများကို ပြန်လည်ဆွဲယူပြီး ပြသသည်
                    // generateSeatingPlan(selectedCinema.id); // onSnapshot က အလိုအလျောက် update လုပ်ပေးမည်
                } finally {
                    hideLoading(); // Loading ကို ဖျောက်သည်
                }
            }


            // Event Listeners များ
            buyTicketsBtn.addEventListener('click', () => navigateTo('cinemaSelectionPage'));
            
            cinemaButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const cinemaId = button.dataset.cinema;
                    generateSeatingPlan(cinemaId);
                });
            });

            confirmBookingBtn.addEventListener('click', attemptBooking); // Booking လုပ်ဆောင်ရန် function ကို ခေါ်သည်
            
            paymentLink.addEventListener('click', () => {
                clearInterval(countdownInterval); // ငွေပေးချေမှု လင့်ခ်ကို နှိပ်လျှင် countdown ကို ရပ်သည်
            });

            // နောက်ပြန်ခလုတ် Event Listeners များ
            backToIntroBtn.addEventListener('click', () => navigateTo('introPage'));
            backToCinemaBtn.addEventListener('click', () => navigateTo('cinemaSelectionPage'));
            backToSeatingBtn.addEventListener('click', () => navigateTo('seatingPlanPage'));
        });
    </script>
</body>
</html>
